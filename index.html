<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mila Vola - Microtask Malagasy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, sendEmailVerification, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAC-P6WFH1kqfYQi3PdCWpy4LSUqvtX_vo",
      authDomain: "mila-vola.firebaseapp.com",
      projectId: "mila-vola",
      storageBucket: "mila-vola.appspot.com",
      messagingSenderId: "690624768352",
      appId: "1:690624768352:web:668994ef2664c5b99dd605",
      measurementId: "G-C3FZTKQHFP"
    };
    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Fampiasa hanovana ny pejy hita
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      window.scrollTo(0, 0);
    }

    // Fonction pour afficher les notifications
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }

    // Fanaraha-maso ny fidirana (Auth State)
    auth.onAuthStateChanged(user => {
      if (user) {
        showSection('home-section');
        updateAccountInfo(user.uid);
        loadTasks();
        
        // Vérifier si l'utilisateur est admin
        checkAdminStatus(user.uid);
      } else {
        showSection('reg-section');
      }
    });

    // Vérifier le statut admin
    async function checkAdminStatus(uid) {
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        if (data.isAdmin) {
          document.getElementById('admin-section').style.display = 'block';
          loadAdminRequests();
        }
      }
    }

    // ===== Inscription par téléphone =====
    window.setupPhoneAuth = function() {
      // Mametraka reCAPTCHA invisible
      window.recaptchaVerifier = new RecaptchaVerifier('phone-signup-button', {'size': 'invisible'}, auth);
    }
    
    window.sendPhoneCode = function() {
      const phoneNumber = document.getElementById('phone-input').value;
      // Mandeha manao SMS code ho an'ny number
      signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
        .then((confirmationResult) => {
          window.confirmationResult = confirmationResult;
          showNotification('Code de vérification nalefa tamin\'ny SMS!');
          document.getElementById('phone-code-section').style.display = 'block';
        })
        .catch((error) => {
          console.error(error);
          showNotification(`Tsy nahomby: ${error.message}`, 'error');
        });
    }
    
    window.verifyPhoneCode = async function() {
      const code = document.getElementById('phone-code').value;
      try {
        const result = await window.confirmationResult.confirm(code);
        const user = result.user;
        // Manoratra mpampiasa ao Firestore rehefa avy ny verification
        await setDoc(doc(db, 'users', user.uid), {
          name: document.getElementById('phone-name').value,
          phone: user.phoneNumber,
          email: '',
          deposit: 0,
          gains: 0,
          isAdmin: false
        });
        showSection('home-section');
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }

    // ===== Inscription par email =====
    window.emailSignUp = async function() {
      const email = document.getElementById('email-input').value;
      const name = document.getElementById('email-name').value;
      const password = document.getElementById('email-password').value;
      
      if (!email || !name || !password) {
        showNotification('Fenoy ny saha rehetra!', 'error');
        return;
      }
      
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        // Mandefa mail de confirmation
        await sendEmailVerification(userCred.user);
        // Manoratra mpampiasa vaovao ao Firestore
        await setDoc(doc(db, 'users', userCred.user.uid), {
          name: name,
          email: email,
          phone: '',
          deposit: 0,
          gains: 0,
          isAdmin: false
        });
        showNotification('Mail fanamafisana nalefa. Zahao ny mailakao!');
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }
    
    // ===== Connexion par email =====
    window.emailLogin = async function() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }

    // ===== Connexion via Google =====
    window.googleSignIn = async function() {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        // Manoratra na manavao ny mpampiasa ao Firestore
        await setDoc(doc(db, 'users', user.uid), {
          name: user.displayName,
          email: user.email,
          phone: user.phoneNumber || '',
          deposit: 0,
          gains: 0,
          isAdmin: false
        }, { merge: true });
        showSection('home-section');
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }
    
    // ===== Déconnexion =====
    window.logout = async function() {
      try {
        await auth.signOut();
        showSection('reg-section');
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }

    // ===== Mampiseho ny kaonty mpampiasa =====
    async function updateAccountInfo(uid) {
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        document.getElementById('account-gains').innerText = data.gains.toLocaleString() + ' Ariary';
        document.getElementById('account-deposit').innerText = data.deposit.toLocaleString() + ' Ariary';
        document.getElementById('user-name').innerText = data.name;
        document.getElementById('ref-link').innerText = `https://mila-vola.com/?ref=${uid}`;
      }
    }

    // ===== Dépôt =====
    window.requestDeposit = async function() {
      const amount = parseInt(document.getElementById('deposit-amount').value);
      const method = document.getElementById('deposit-method').value;
      
      if (!amount || isNaN(amount)) {
        showNotification('Ampidiro ny vola tadiavina', 'error');
        return;
      }
      
      if (amount < 5000) {
        showNotification('Minimum dépôt: 5,000 Ariary.', 'error');
        return;
      }
      
      try {
        // Manoratra fangatahana dépôt ao amin'ny Firestore
        await addDoc(collection(db, 'deposit_requests'), {
          userId: auth.currentUser.uid,
          userName: document.getElementById('user-name').innerText,
          amount: amount,
          method: method,
          date: new Date(),
          status: 'pending'
        });
        showNotification('Demande dépôt nalefa. Miandry confirmation avy amin\'ny admin.');
        document.getElementById('deposit-amount').value = '';
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }
    
    // ===== Retrait =====
    window.requestWithdraw = async function() {
      const amount = parseInt(document.getElementById('withdraw-amount').value);
      const tel = document.getElementById('withdraw-phone').value;
      const name = document.getElementById('withdraw-name').value;
      
      if (!amount || isNaN(amount)) {
        showNotification('Ampidiro ny vola tadiavina', 'error');
        return;
      }
      
      if (amount < 10000) {
        showNotification('Montant minimum ho an\'ny retrait dia 10,000 AR.', 'error');
        return;
      }
      
      if (!tel || !name) {
        showNotification('Fenoy ny saha rehetra!', 'error');
        return;
      }
      
      try {
        // Manoratra fangatahana retrait
        await addDoc(collection(db, 'withdraw_requests'), {
          userId: auth.currentUser.uid,
          userName: document.getElementById('user-name').innerText,
          amount: amount,
          phone: tel,
          name: name,
          date: new Date(),
          status: 'pending'
        });
        showNotification('Demande retrait nalefa. Miandry confirmation avy amin\'ny admin.');
        document.getElementById('withdraw-amount').value = '';
        document.getElementById('withdraw-phone').value = '';
        document.getElementById('withdraw-name').value = '';
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }

    // ===== Publier une tâche =====
    window.postTask = async function() {
      const desc = document.getElementById('task-desc').value;
      const budget = parseInt(document.getElementById('task-budget').value);
      const instructions = document.getElementById('task-instructions').value;
      const conditions = document.getElementById('task-conditions').value;
      
      if (!desc || !budget || !instructions) {
        showNotification('Fenoy ny saha rehetra!', 'error');
        return;
      }
      
      if (budget < 50) {
        showNotification('Budget/minimum par personne: 50 AR.', 'error');
        return;
      }
      
      try {
        // Manoratra asa vaovao ao Firestore
        await addDoc(collection(db, 'tasks'), {
          userId: auth.currentUser.uid,
          userName: document.getElementById('user-name').innerText,
          description: desc,
          budget: budget,
          instructions: instructions,
          conditions: conditions,
          date: new Date(),
          participants: []
        });
        showNotification('Tâche nalefa!');
        document.getElementById('task-desc').value = '';
        document.getElementById('task-budget').value = '';
        document.getElementById('task-instructions').value = '';
        document.getElementById('task-conditions').value = '';
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }

    // ===== Charger les tâches =====
    async function loadTasks() {
      const tasksList = document.getElementById('tasks-list');
      tasksList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Mitady asa...</div>';
      
      try {
        const querySnapshot = await getDocs(collection(db, 'tasks'));
        tasksList.innerHTML = '';
        
        if (querySnapshot.empty) {
          tasksList.innerHTML = '<div class="empty">Tsy misy asa mbola misy ankehitriny</div>';
          return;
        }
        
        querySnapshot.forEach(doc => {
          const task = doc.data();
          const taskElement = document.createElement('div');
          taskElement.className = 'task-card';
          taskElement.innerHTML = `
            <div class="task-header">
              <h4>${task.description}</h4>
              <span class="task-budget">${task.budget.toLocaleString()} AR</span>
            </div>
            <p><strong>Torolalana:</strong> ${task.instructions}</p>
            <p><strong>Fepetra:</strong> ${task.conditions || 'Tsy misy'}</p>
            <div class="task-footer">
              <span><i class="fas fa-user"></i> ${task.userName}</span>
              <button class="btn-task" onclick="sendProof('${doc.id}')"><i class="fas fa-paper-plane"></i> Alefa preuve</button>
            </div>
          `;
          tasksList.appendChild(taskElement);
        });
      } catch(error) {
        console.error(error);
        tasksList.innerHTML = '<div class="error">Nisy olana niseho tamin\'ny fikarohana asa</div>';
      }
    }

    // ===== Envoyer preuve =====
    window.sendProof = async function(taskId) {
      try {
        // Manao fangatahana preuve
        await addDoc(collection(db, 'proofs'), {
          userId: auth.currentUser.uid,
          userName: document.getElementById('user-name').innerText,
          taskId: taskId,
          date: new Date(),
          status: 'pending'
        });
        showNotification('Preuve nalefa! Miandry confirmation avy amin\'ny admin.');
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }

    // ===== Section Admin =====
    async function loadAdminRequests() {
      // Charger les demandes de dépôt
      loadRequests('deposit_requests', 'admin-deposits', 'Dépôt');
      
      // Charger les demandes de retrait
      loadRequests('withdraw_requests', 'admin-withdraws', 'Retrait');
      
      // Charger les preuves
      loadProofs();
    }
    
    async function loadRequests(collectionName, elementId, type) {
      const container = document.getElementById(elementId);
      container.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Mitady...</td></tr>';
      
      try {
        const q = query(collection(db, collectionName), where("status", "==", "pending"));
        const querySnapshot = await getDocs(q);
        container.innerHTML = '';
        
        if (querySnapshot.empty) {
          container.innerHTML = '<tr><td colspan="6" class="text-center">Tsy misy fangatahana</td></tr>';
          return;
        }
        
        querySnapshot.forEach(doc => {
          const request = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${request.userName}</td>
            <td>${type}</td>
            <td>${request.amount.toLocaleString()} AR</td>
            <td>${request.date.toDate().toLocaleString()}</td>
            <td>${request.method || request.phone || ''}</td>
            <td class="actions">
              <button class="btn-confirm" onclick="adminAction('${collectionName}', '${doc.id}', 'confirmed')"><i class="fas fa-check"></i></button>
              <button class="btn-cancel" onclick="adminAction('${collectionName}', '${doc.id}', 'cancelled')"><i class="fas fa-times"></i></button>
            </td>
          `;
          container.appendChild(row);
        });
      } catch(error) {
        console.error(error);
        container.innerHTML = '<tr><td colspan="6" class="text-center error">Nisy olana niseho</td></tr>';
      }
    }
    
    async function loadProofs() {
      const container = document.getElementById('admin-proofs');
      container.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Mitady...</td></tr>';
      
      try {
        const q = query(collection(db, 'proofs'), where("status", "==", "pending"));
        const querySnapshot = await getDocs(q);
        container.innerHTML = '';
        
        if (querySnapshot.empty) {
          container.innerHTML = '<tr><td colspan="5" class="text-center">Tsy misy preuve</td></tr>';
          return;
        }
        
        querySnapshot.forEach(async (doc) => {
          const proof = doc.data();
          const taskDoc = await getDoc(doc(db, 'tasks', proof.taskId));
          const task = taskDoc.data();
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${proof.userName}</td>
            <td>${task.description}</td>
            <td>${task.budget.toLocaleString()} AR</td>
            <td>${proof.date.toDate().toLocaleString()}</td>
            <td class="actions">
              <button class="btn-confirm" onclick="adminAction('proofs', '${doc.id}', 'confirmed')"><i class="fas fa-check"></i></button>
              <button class="btn-cancel" onclick="adminAction('proofs', '${doc.id}', 'cancelled')"><i class="fas fa-times"></i></button>
            </td>
          `;
          container.appendChild(row);
        });
      } catch(error) {
        console.error(error);
        container.innerHTML = '<tr><td colspan="5" class="text-center error">Nisy olana niseho</td></tr>';
      }
    }
    
    // ===== Action Admin =====
    window.adminAction = async function(collectionName, docId, action) {
      try {
        const docRef = doc(db, collectionName, docId);
        await updateDoc(docRef, {
          status: action,
          processedBy: auth.currentUser.uid,
          processedAt: new Date()
        });
        
        // Si c'est une confirmation, mettre à jour le solde utilisateur
        if (action === 'confirmed') {
          if (collectionName === 'deposit_requests') {
            await updateUserBalance(docRef, 'deposit');
          } else if (collectionName === 'proofs') {
            await updateUserBalance(docRef, 'gains');
          }
        }
        
        showNotification(`Demande ${action === 'confirmed' ? 'nohamafisina' : 'navoanana'} soa aman-tsara`);
        loadAdminRequests();
      } catch(error) {
        console.error(error);
        showNotification(`Tsy nahomby: ${error.message}`, 'error');
      }
    }
    
    async function updateUserBalance(docRef, field) {
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const request = docSnap.data();
        const userRef = doc(db, 'users', request.userId);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          const userData = userSnap.data();
          const newValue = userData[field] + request.amount;
          await updateDoc(userRef, { [field]: newValue });
        }
      }
    }
  </script>
  <style>
    /* CSS PROFESSIONNEL */
    :root {
      --primary: #3498db;
      --secondary: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --gray: #95a5a6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .section {
      display: none;
      background: white;
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 25px;
      margin: 20px 0;
    }
    
    .header {
      background: linear-gr
