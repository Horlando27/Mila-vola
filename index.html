<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mila Vola - Microtask Malagasy</title>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    
    // Firebase configuration (rakitra)
    const firebaseConfig = {
      apiKey: "AIzaSyAC-P6WFH1kqfYQi3PdCWpy4LSUqvtX_vo",
      authDomain: "mila-vola.firebaseapp.com",
      projectId: "mila-vola",
      storageBucket: "mila-vola.firebasestorage.app",
      messagingSenderId: "690624768352",
      appId: "1:690624768352:web:668994ef2664c5b99dd605",
      measurementId: "G-C3FZTKQHFP"
    };
    // Initialisation Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Fampiasa hanovana ny pejys hita
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // Fanaraha-maso ny fidirana (Auth State)
    auth.onAuthStateChanged(user => {
      if (user) {
        showSection('home-section');
        // Avy eo azo atao ny maka ny mombamomba ny mpampiasa (kaonty sns)
        updateAccountInfo(user.uid);
      } else {
        showSection('reg-section');
      }
    });

    // ===== Inscription par téléphone =====
    window.setupPhoneAuth = function() {
      // Mametraka reCAPTCHA invisible
      window.recaptchaVerifier = new RecaptchaVerifier('phone-signup-button', {'size': 'invisible'}, auth);
    }
    window.sendPhoneCode = function() {
      const phoneNumber = document.getElementById('phone-input').value;
      // Mandeha manao SMS code ho an'ny number
      signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
        .then((confirmationResult) => {
          window.confirmationResult = confirmationResult;
          alert('Code de vérification nalefa tamin\'ny SMS!');
        })
        .catch((error) => {
          console.error(error);
        });
    }
    window.verifyPhoneCode = async function() {
      const code = document.getElementById('phone-code').value;
      try {
        const result = await window.confirmationResult.confirm(code);
        const user = result.user;
        // Manoratra mpampiasa ao Firestore rehefa avy ny verification
        await setDoc(doc(db, 'users', user.uid), {
          name: document.getElementById('phone-name').value,
          phone: user.phoneNumber,
          email: '',
          deposit: 0,
          gains: 0
        });
        showSection('home-section');
      } catch(error) {
        console.error(error);
      }
    }

    // ===== Inscription par email =====
    window.emailSignUp = async function() {
      const email = document.getElementById('email-input').value;
      const name = document.getElementById('email-name').value;
      const password = document.getElementById('email-password').value;
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        // Mandefa mail de confirmation
        await sendEmailVerification(userCred.user);
        // Manoratra mpampiasa vaovao ao Firestore
        await setDoc(doc(db, 'users', userCred.user.uid), {
          name: name,
          email: email,
          phone: '',
          deposit: 0,
          gains: 0
        });
        alert('Mail fanamafisana nalefa. Zahao ny mailakao!');
      } catch(error) {
        console.error(error);
      }
    }

    // ===== Connexion via Google =====
    window.googleSignIn = async function() {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        // Manoratra na manavao ny mpampiasa ao Firestore
        await setDoc(doc(db, 'users', user.uid), {
          name: user.displayName,
          email: user.email,
          phone: user.phoneNumber || '',
          deposit: 0,
          gains: 0
        });
        showSection('home-section');
      } catch(error) {
        console.error(error);
      }
    }

    // ===== Mampiseho ny kaonty mpampiasa =====
    async function updateAccountInfo(uid) {
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        document.getElementById('account-gains').innerText = data.gains + ' Ariary';
        document.getElementById('account-deposit').innerText = data.deposit + ' Ariary';
      }
    }

    // ===== Dépôt sy Retrait =====
    window.requestDeposit = async function() {
      const amount = parseInt(document.getElementById('deposit-amount').value);
      const method = document.getElementById('deposit-method').value;
      if (amount < 5000) {
        alert('Minimum dépôt: 5000 Ariary.');
        return;
      }
      // Manoratra fangatahana dépôt ao amin'ny Firestore
      await addDoc(collection(db, 'deposit_requests'), {
        userId: auth.currentUser.uid,
        amount: amount,
        method: method,
        status: 'pending'
      });
      alert('Demande dépôt nalefa. Miandry confirmation avy amin\'ny admin.');
    }
    window.requestWithdraw = async function() {
      const amount = parseInt(document.getElementById('withdraw-amount').value);
      const tel = document.getElementById('withdraw-phone').value;
      const name = document.getElementById('withdraw-name').value;
      if (amount < 10000) {
        alert('Montant minimum ho an’ny retrait dia 10000 AR.');
        return;
      }
      // Manoratra fangatahana retrait
      await addDoc(collection(db, 'withdraw_requests'), {
        userId: auth.currentUser.uid,
        amount: amount,
        phone: tel,
        name: name,
        status: 'pending'
      });
      alert('Demande retrait nalefa. Miandry confirmation avy amin\'ny admin.');
    }

    // ===== Publier une tâche =====
    window.postTask = async function() {
      const desc = document.getElementById('task-desc').value;
      const budget = parseInt(document.getElementById('task-budget').value);
      const instructions = document.getElementById('task-instructions').value;
      const conditions = document.getElementById('task-conditions').value;
      if (budget < 50) {
        alert('Budget/minimum par personne: 50 AR.');
        return;
      }
      // Manoratra asa vaovao ao Firestore
      await addDoc(collection(db, 'tasks'), {
        userId: auth.currentUser.uid,
        description: desc,
        budget: budget,
        instructions: instructions,
        conditions: conditions,
        participants: []
      });
      alert('Tâche nalefa!');
    }

    // ===== Exemple fandefasana preuve =====
    window.sendProof = async function(taskId) {
      // Manao fangatahana preuve (atsangana ary alefa any amin'ny admin)
      await addDoc(collection(db, 'proofs'), {
        userId: auth.currentUser.uid,
        taskId: taskId,
        status: 'pending'
      });
      alert('Preuve nalefa! Miandry confirmation avy amin\'ny admin.');
    }
  </script>
  <style>
    .section { display: none; margin: 20px; }
    input, select, textarea { display: block; margin: 5px 0; width: 250px; }
    button { margin: 5px 0; padding: 5px 10px; }
  </style>
</head>
<body>
  <!-- Fisoratana anarana -->
  <div id="reg-section" class="section">
    <h2>Inscription - Mila Vola</h2>
    <!-- Par téléphone -->
    <div>
      <h3>Par téléphone</h3>
      <input type="tel" id="phone-input" placeholder="+261 xx xx xx xx">
      <input type="text" id="phone-name" placeholder="Anarana feno">
      <input type="password" id="phone-password" placeholder="Teny miafina">
      <button onclick="setupPhoneAuth(); sendPhoneCode();" id="phone-signup-button">Andefaso code</button>
      <input type="text" id="phone-code" placeholder="Code SMS">
      <button onclick="verifyPhoneCode()">Valider code</button>
    </div>
    <!-- Par email -->
    <div>
      <h3>Par email</h3>
      <input type="email" id="email-input" placeholder="Email valide">
      <input type="text" id="email-name" placeholder="Anarana feno">
      <input type="password" id="email-password" placeholder="Teny miafina">
      <button onclick="emailSignUp()">S'inscrire</button>
    </div>
    <!-- Par Google -->
    <div>
      <h3>Connexion Google</h3>
      <button onclick="googleSignIn()">Google Sign-In</button>
    </div>
  </div>

  <!-- Pejy fandraisana / Dashboard -->
  <div id="home-section" class="section">
    <h2>Pejy fandraisana - Mila Vola</h2>
    <!-- Section Compte -->
    <div>
      <h3>Compte</h3>
      <p>Solde Gains: <span id="account-gains">0 Ariary</span></p>
      <p>Solde Dépôt: <span id="account-deposit">0 Ariary</span></p>
      <!-- Dépôt -->
      <h4>Dépôt</h4>
      <input type="number" id="deposit-amount" placeholder="Montant dépôt (min 5000)">
      <select id="deposit-method">
        <option value="mvola">Mvola (0323911654)</option>
        <option value="orange">Orange Money (0323911654)</option>
      </select>
      <button onclick="requestDeposit()">Envoyer dépôt</button>
      <!-- Retrait -->
      <h4>Retrait</h4>
      <input type="number" id="withdraw-amount" placeholder="Montant retrait (min 10000)">
      <input type="tel" id="withdraw-phone" placeholder="Telma (032...)">
      <input type="text" id="withdraw-name" placeholder="Anarana feno">
      <button onclick="requestWithdraw()">Retirer</button>
    </div>

    <!-- Section Asa (Tasks) -->
    <div>
      <h3>Asa azo atao</h3>
      <div id="tasks-list">
        <!-- Eto haseho ny lisitry ny tasks avy amin'ny Firestore -->
        <!-- Ohatra fotsiny: -->
        <div class="task">
          <p><strong>Ohatra: Midira ao amin'ny group Facebook</strong></p>
          <button onclick="sendProof('exampleTaskId')">Envoyer preuve</button>
        </div>
      </div>
    </div>

    <!-- Section Publication -->
    <div>
      <h3>Publier une tâche</h3>
      <textarea id="task-desc" placeholder="Description asa"></textarea>
      <input type="number" id="task-budget" placeholder="Budget / olona (min 50 AR)">
      <input type="text" id="task-instructions" placeholder="Torolalana / Lien">
      <input type="text" id="task-conditions" placeholder="Fepetra takiana (conditions)">
      <button onclick="postTask()">Envoyer</button>
    </div>

    <!-- Section Paramètres -->
    <div>
      <h3>Paramètres</h3>
      <p>Rohy referal: <span id="ref-link">https://mila-vola.com/?ref=USER_ID</span></p>
      <p>Bonus parrainage: 5%</p>
    </div>

    <!-- Section Admin -->
    <div>
      <h3>Section Admin</h3>
      <div>
        <h4>Demandes dépôt</h4>
        <div id="admin-deposits"></div>
      </div>
      <div>
        <h4>Demandes retrait</h4>
        <div id="admin-withdraws"></div>
      </div>
      <div>
        <h4>Preuves asa</h4>
        <div id="admin-proofs"></div>
      </div>
    </div>
  </div>
</body>
    </html>
